<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Using the Database - Pisces</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Using the Database";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Pisces</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Tutorial</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../tutorial.tables/">Database Tables</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Using the Database</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#using-the-database">Using the Database</a></li>
                
                    <li><a class="toctree-l4" href="#introduction">Introduction</a></li>
                
                    <li><a class="toctree-l4" href="#loading-tables">Loading Tables</a></li>
                
                    <li><a class="toctree-l4" href="#querying-tables">Querying Tables</a></li>
                
                    <li><a class="toctree-l4" href="#using-ids">Using ids</a></li>
                
                    <li><a class="toctree-l4" href="#copying-data-between-tables">Copying Data between Tables</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../tutorial.waveforms/">Import/Export Waveforms</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../tutorial.flatfiles/">Import/Export Flat Files</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../api/">API Documentation</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>About</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../about.roadmap/">Roadmap</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../about.license/">License</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../about.group/">User's Group</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Pisces</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Tutorial &raquo;</li>
        
      
    
    <li>Using the Database</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/jkmacc-lanl/pisces" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="using-the-database">Using the Database</h1>
<p>Load, query, join, write, and copy tables.</p>
<hr />
<h2 id="introduction">Introduction</h2>
<p>In this tutorial, we'll make a database connection, load or import tables, and work with them.</p>
<p>To begin, we'll make a database connection.  </p>
<pre><code>import pisces as ps

# connect with Oracle
session = ps.db_connect(user='scott', backend='oracle', server='my.server.edu', 
                        port=1521, instance='mydb')

# connect with sqlite 
session = ps.db_connect(backend='sqlite', instance='/path/to/mydb.sqlite')
</code></pre>
<p><em>You'll need to substitute in your own username, of course.</em></p>
<p><code>db_connect</code> will prompt you for your password and returns a SQLAlchemy
<a href="http://docs.sqlalchemy.org/en/rel_0_8/orm/session.html">Session</a>
instance, which manages database transactions. It can also take a single
fully-qualified database URL (e.g. <code>oracle://scott:tiger@my.server.edu:1521/mydb</code> or
<code>sqlite:///path/to/mydb.sqlite</code>), which is passed to
<a href="http://docs.sqlalchemy.org/en/rel_0_8/core/engines.html#sqlalchemy.create_engine"><code>sqlalchemy.create_engine</code></a>.
The returned session is bound to the database through the <code>.bind</code> attribute,
which is a SQLAlchemy <a href="http://docs.sqlalchemy.org/en/rel_0_9/core/engines.html">Engine</a> instance that specifies the database
location and drivers.</p>
<hr />
<h2 id="loading-tables">Loading Tables</h2>
<p>Tables can be loaded in one of three ways: </p>
<ol>
<li>Imported from your own table definition modules</li>
<li>Arbitrary tables reflected from the database</li>
<li>Arbitrary tables reflected from the database, with enhancements</li>
</ol>
<p>Number 1 is the recommended way, as it returns a class with useful methods like <code>to_trace</code> for waveform tables, default value instantiation, and easy flat file conversion.
Number 2 returns a class with none of the above enhancements.
It is good for quick table loading when you have no prior knowledge of the table or you don't have a table prototype to use for it.
Number 3 returns a class with default value instantiation and easy flat file <em>writing</em>, but no other Pisces-specific class methods.</p>
<h3 id="import-your-defined-tables">Import your defined tables</h3>
<p>Import tables/classes from modules where you previously defined them, as in the <a href="../Using the Database">previous tutorial page</a>.
This is the preferred way to load tables, as it offers the most flexibility and functionality.</p>
<pre><code>import from mytables import Site, Wfdisc, Origin
</code></pre>
<h3 id="arbitrary-tables">Arbitrary tables</h3>
<p>If you only know the table name (and account), you can load a table using <code>get_tables</code>:</p>
<pre><code># Oracle account.table syntax
Site, Affil, Origin = ps.get_tables(session.bind, ['user.site', 'user.affiliation', 
                                                   'user.origin'])

# SQLite syntax, no account
Site, Affil, Origin = ps.get_tables(session.bind, ['site', 'affiliation', 'origin'])
</code></pre>
<p>Loaded tables are just Python classes defined using <a href="http://docs.sqlalchemy.org/en/rel_0_8/orm/">SQLAlchemy’s Object Relational Mapper (ORM)</a>.
Table classes loaded together share a <code>.metadata</code>.
<a href="http://docs.sqlalchemy.org/en/rel_0_8/core/metadata.html#sqlalchemy.schema.MetaData">MetaData</a>
is a Python representation of underlying SQL objects, and can be used to
issue create/add/drop statements to the database. To add tables loaded
later to the same MetaData, use the <code>metadata=</code> flag with the existing
instance from one of the earlier-loaded tables:</p>
<pre><code>Wfdisc, Assoc = ps.get_tables(session.bind, ['user.wfdisc', 'user.assoc'], metadata=Site.metadata)

# check the table names in the metadata
print Site.metadata.tables.keys()
</code></pre>
<p>Tables present in your MetaData can be seen in its <code>.tables</code> dictionary:</p>
<pre><code>['user.affiliation',  'user.site',  'user.wfdisc',  'user.origin',  'user.assoc']
</code></pre>
<h4 id="tables-must-have-a-primary-key">Tables must have a primary key</h4>
<p>SQLAlchemy’s ORM needs a primary key for the <code>session</code> to keep track of rows. If a database table is actually just a view of other tables, or a primary key was never specified,
we can specify the primary key in a dictionary and the <code>primary_keys=</code> keyword.</p>
<pre><code>try:
    Sitechan, = ps.get_tables(session.bind, ['user.sitechan'])
except ArgumentError:
    # failed because user.sitechan has no primary key.  we can force one with primary_keys
    Sitechan, = ps.get_tables(session.bind, ['user.sitechan'], 
                              primary_keys={'user.sitechan': ['chanid']})
</code></pre>
<h3 id="arbitrary-enhanced-tables">Arbitrary enhanced tables</h3>
<p>When the <code>base=</code> option is used with a <a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/extensions/declarative.html">Declarative Base</a> class that comes with Pisces,
loaded classes get the following enhancements:</p>
<ul>
<li>The default values for all fields in a table row (class instance) are filled whether or not the underlying database defines default values.</li>
<li>The class can form its own string representation (flat file row).</li>
<li>Instances of the class can iterate over values, and in the correct order.</li>
</ul>
<p>Note: this will only work if the field names in the table being loaded have been used with this base before.</p>
<pre><code># load table classes, matching column names with those of a known schema

from pisces.schema.css3 import Base

Site, Affil, Origin = ps.get_tables(session.bind, ['global.site','global.affiliation', 'global.origin'], base=Base)
</code></pre>
<p><code>Base</code> is the parent class for all pre-defined table prototypes in a given schema that comes with Pisces. </p>
<hr />
<h2 id="querying-tables">Querying Tables</h2>
<p>Querying and editing tables in Pisces is the same as using SQLAlchemy’s
ORM. Follow SQLAlchemy’s
<a href="http://docs.sqlalchemy.org/en/rel_0_8/orm/tutorial.html">tutorial</a> to
learn more about how this works.</p>
<pre><code># query all TA stations installed in 2009
q = session.query(Site).filter(Site.ondate.between(2009001, 2009365))
ta_sites = q.filter(Site.sta == Affil.sta).filter(Affil.net == 'TA').all()

# query for a subset of western US earthquakes, sorted by mb
q = session.query(Origin).filter(Origin.lat.between(35, 45)).filter(Origin.mb &gt; 4)
wus_quakes = q.filter(Origin.lon.between(-115, -105)).order_by(Origin.mb).all()

# plot 'em
import matplotlib.pyplot as plt
from mpl_toolkits.basemap import Basemap
m = Basemap(llcrnrlon=-130, llcrnrlat=25, urcrnrlon=-80, urcrnrlat=60, resolution='i')
m.etopo()

for ista in ta_sites:
    x, y = m(ista.lon, ista.lat)
    m.plot(x, y, 'b^')

for io in wus_quakes:
    x, y = m(io.lon, io.lat)
    m.plot(x, y, 'r*')

plt.title("{} TA stations and {} quakes mb &gt; 4".format(len(ta_sites), len(wus_quakes)))
</code></pre>
<p><img alt="western US" src="https://raw.github.com/jkmacc-LANL/pisces/dev/docs/source/pages/data/wUS.png" title="western US" /></p>
<h3 id="query-builders">Query-builders</h3>
<p>Pisces has a set of intuitive query-building functions for common
seismic queries in <code>pisces.request</code>.</p>
<pre><code>import pisces.request as req

# repeat the previous query for a subset of western US earthquakes
wus_quakes = req.get_events(session, Origin, region=(-115, -105, 35, 45), mag={'mb': (4, None)})

# to sort by mb, ask for the query back and do your sort
wus_quakes = req.get_events(session, Origin, region=(-115, -105, 35, 45), mag={'mb': (4, None)}, asquery=True).order_by(Origin.mb).all()
</code></pre>
<p>Pisces uses NumPy/ObsPy to do distance subsets, which are done out-of-database and can be memory intensive. 
They can be done in-database, if you have a stored function "xkm_distance", for example, that calculates lateral distances.</p>
<pre><code># stations &lt;= 200 km from lat 42, lon -110, out-of-database
sites = req.get_stations(session, Site, km=(42, -110, 0, 200))

# in-database "xkm_distance(lat1, lon1, lat2, lon2)" function
from sqlalchemy import func
sites = req.get_stations(session, Site, asquery=True).filter(func.xkm_distance(Site.lat, Site.lon, 42, -110).between(0, 200)).all()
</code></pre>
<h3 id="editing-tables">Editing tables</h3>
<pre><code># add Albuquerque ANMO and the Chelyabinsk bolide
ANMO = Site(sta='ANMO', lat=34.9459, lon=-106.4572, elev=1.85)
bolide = Origin(orid=1, lat=55.15, lon=61.41, mb=2.7, etype='xm')
session.add_all([ANMO, bolide])
session.commit()

# edit a Site, delete an Origin
session.query(Site).filter(Site.sta == 'MK31').update({'lat': 42.5})
session.query(Origin).filter(Origin.orid = 1001).delete()
session.commit()
session.close()
</code></pre>
<p>Note that not all fields/attributes were specified when creating “ANMO”
or “bolide”, but their default values are filled in.</p>
<hr />
<h2 id="using-ids">Using ids</h2>
<hr />
<h2 id="copying-data-between-tables">Copying Data between Tables</h2>
<hr />
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../tutorial.waveforms/" class="btn btn-neutral float-right" title="Import/Export Waveforms"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../tutorial.tables/" class="btn btn-neutral" title="Database Tables"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/jkmacc-lanl/pisces" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../tutorial.tables/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../tutorial.waveforms/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
