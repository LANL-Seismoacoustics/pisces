<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://www.jkmacc-LANL.github.io/pisces/tutorial.queries/">
        <link rel="shortcut icon" href="../img/favicon.ico">

        <title>Using the Database - Pisces</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/prettify-1.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">Pisces</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorial <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            <li >
                                <a href="../tutorial.tables/">Database Tables</a>
                            </li>
                        
                            <li class="active">
                                <a href="./">Using the Database</a>
                            </li>
                        
                            <li >
                                <a href="../tutorial.waveforms/">Import/Export Waveforms</a>
                            </li>
                        
                            <li >
                                <a href="../tutorial.flatfiles/">Import/Export Flat Files</a>
                            </li>
                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../api/">API Documentation</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            <li >
                                <a href="../about.roadmap/">Roadmap</a>
                            </li>
                        
                            <li >
                                <a href="../about.license/">License</a>
                            </li>
                        
                            <li >
                                <a href="../about.group/">User's Group</a>
                            </li>
                        
                        </ul>
                    </li>
                
                
                </ul>
            

            
            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                
                <li >
                    <a rel="next" href="../tutorial.tables/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../tutorial.waveforms/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                
                <li>
                    <a href="https://github.com/jkmacc-lanl/pisces">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
            
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#using-the-database">Using the Database</a></li>
        
            <li><a href="#introduction">Introduction</a></li>
        
            <li><a href="#loading-tables">Loading Tables</a></li>
        
            <li><a href="#querying-tables">Querying Tables</a></li>
        
            <li><a href="#using-ids">Using ids</a></li>
        
            <li><a href="#copying-data-between-tables">Copying Data between Tables</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="using-the-database">Using the Database</h1>
<p>Load, query, join, write, and copy tables.</p>
<hr />
<h2 id="introduction">Introduction</h2>
<p>In this tutorial, we'll make a database connection, load or import tables, and work with them.</p>
<p>To begin, we'll make a database connection.  </p>
<pre class="prettyprint well"><code>import pisces as ps

# connect with Oracle
session = ps.db_connect(user='scott', backend='oracle', server='my.server.edu', 
                        port=1521, instance='mydb')

# connect with sqlite 
session = ps.db_connect(backend='sqlite', instance='/path/to/mydb.sqlite')
</code></pre>
<p><em>You'll need to substitute in your own username, of course.</em></p>
<p><code>db_connect</code> will prompt you for your password and returns a SQLAlchemy
<a href="http://docs.sqlalchemy.org/en/rel_0_8/orm/session.html">Session</a>
instance, which manages database transactions. It can also take a single
fully-qualified database URL (e.g. <code>oracle://scott:tiger@my.server.edu:1521/mydb</code> or
<code>sqlite:///path/to/mydb.sqlite</code>), which is passed to
<a href="http://docs.sqlalchemy.org/en/rel_0_8/core/engines.html#sqlalchemy.create_engine"><code>sqlalchemy.create_engine</code></a>.
The returned session is bound to the database through the <code>.bind</code> attribute,
which is a SQLAlchemy <a href="http://docs.sqlalchemy.org/en/rel_0_9/core/engines.html">Engine</a> instance that specifies the database
location and drivers.</p>
<hr />
<h2 id="loading-tables">Loading Tables</h2>
<p>Tables can be loaded in one of three ways: </p>
<ol>
<li>Imported from your own table definition modules</li>
<li>Arbitrary tables reflected from the database</li>
<li>Arbitrary tables reflected from the database, with enhancements</li>
</ol>
<p>Number 1 is the recommended way, as it returns a class with useful methods like <code>to_trace</code> for waveform tables, default value instantiation, and easy flat file conversion.
Number 2 returns a class with none of the above enhancements.
It is good for quick table loading when you have no prior knowledge of the table or you don't have a table prototype to use for it.
Number 3 returns a class with default value instantiation and easy flat file <em>writing</em>, but no other Pisces-specific class methods.</p>
<h3 id="import-your-defined-tables">Import your defined tables</h3>
<p>Import tables/classes from modules where you previously defined them, as in the <a href="Using%20the%20Database">previous tutorial page</a>.
This is the preferred way to load tables, as it offers the most flexibility and functionality.</p>
<pre class="prettyprint well"><code>import from mytables import Site, Wfdisc, Origin
</code></pre>
<h3 id="arbitrary-tables">Arbitrary tables</h3>
<p>If you only know the table name (and account), you can load a table using <code>get_tables</code>:</p>
<pre class="prettyprint well"><code># Oracle account.table syntax
Site, Affil, Origin = ps.get_tables(session.bind, ['user.site', 'user.affiliation', 
                                                   'user.origin'])

# SQLite syntax, no account
Site, Affil, Origin = ps.get_tables(session.bind, ['site', 'affiliation', 'origin'])
</code></pre>
<p>Loaded tables are just Python classes defined using <a href="http://docs.sqlalchemy.org/en/rel_0_8/orm/">SQLAlchemy’s Object Relational Mapper (ORM)</a>.
Table classes loaded together share a <code>.metadata</code>.
<a href="http://docs.sqlalchemy.org/en/rel_0_8/core/metadata.html#sqlalchemy.schema.MetaData">MetaData</a>
is a Python representation of underlying SQL objects, and can be used to
issue create/add/drop statements to the database. To add tables loaded
later to the same MetaData, use the <code>metadata=</code> flag with the existing
instance from one of the earlier-loaded tables:</p>
<pre class="prettyprint well"><code>Wfdisc, Assoc = ps.get_tables(session.bind, ['user.wfdisc', 'user.assoc'], metadata=Site.metadata)

# check the table names in the metadata
print Site.metadata.tables.keys()
</code></pre>
<p>Tables present in your MetaData can be seen in its <code>.tables</code> dictionary:</p>
<pre class="prettyprint well"><code>['user.affiliation',  'user.site',  'user.wfdisc',  'user.origin',  'user.assoc']
</code></pre>
<h4 id="tables-must-have-a-primary-key">Tables must have a primary key</h4>
<p>SQLAlchemy’s ORM needs a primary key for the <code>session</code> to keep track of rows. If a database table is actually just a view of other tables, or a primary key was never specified,
we can specify the primary key in a dictionary and the <code>primary_keys=</code> keyword.</p>
<pre class="prettyprint well"><code>try:
    Sitechan, = ps.get_tables(session.bind, ['user.sitechan'])
except ArgumentError:
    # failed because user.sitechan has no primary key.  we can force one with primary_keys
    Sitechan, = ps.get_tables(session.bind, ['user.sitechan'], 
                              primary_keys={'user.sitechan': ['chanid']})
</code></pre>
<h3 id="arbitrary-enhanced-tables">Arbitrary enhanced tables</h3>
<p>When the <code>base=</code> option is used with a <a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/extensions/declarative.html">Declarative Base</a> class that comes with Pisces,
loaded classes get the following enhancements:</p>
<ul>
<li>The default values for all fields in a table row (class instance) are filled whether or not the underlying database defines default values.</li>
<li>The class can form its own string representation (flat file row).</li>
<li>Instances of the class can iterate over values, and in the correct order.</li>
</ul>
<p>Note: this will only work if the field names in the table being loaded have been used with this base before.</p>
<pre class="prettyprint well"><code># load table classes, matching column names with those of a known schema

from pisces.schema.css3 import Base

Site, Affil, Origin = ps.get_tables(session.bind, ['global.site','global.affiliation', 'global.origin'], base=Base)
</code></pre>
<p><code>Base</code> is the parent class for all pre-defined table prototypes in a given schema that comes with Pisces. </p>
<hr />
<h2 id="querying-tables">Querying Tables</h2>
<p>Querying and editing tables in Pisces is the same as using SQLAlchemy’s
ORM. Follow SQLAlchemy’s
<a href="http://docs.sqlalchemy.org/en/rel_0_8/orm/tutorial.html">tutorial</a> to
learn more about how this works.</p>
<pre class="prettyprint well"><code># query all TA stations installed in 2009
q = session.query(Site).filter(Site.ondate.between(2009001, 2009365))
ta_sites = q.filter(Site.sta == Affil.sta).filter(Affil.net == 'TA').all()

# query for a subset of western US earthquakes, sorted by mb
q = session.query(Origin).filter(Origin.lat.between(35, 45)).filter(Origin.mb &gt; 4)
wus_quakes = q.filter(Origin.lon.between(-115, -105)).order_by(Origin.mb).all()

# plot 'em
import matplotlib.pyplot as plt
from mpl_toolkits.basemap import Basemap
m = Basemap(llcrnrlon=-130, llcrnrlat=25, urcrnrlon=-80, urcrnrlat=60, resolution='i')
m.etopo()

for ista in ta_sites:
    x, y = m(ista.lon, ista.lat)
    m.plot(x, y, 'b^')

for io in wus_quakes:
    x, y = m(io.lon, io.lat)
    m.plot(x, y, 'r*')

plt.title("{} TA stations and {} quakes mb &gt; 4".format(len(ta_sites), len(wus_quakes)))
</code></pre>
<!-- ![](https://raw.github.com/jkmacc-LANL/pisces/dev/docs/data/wUS.png "western US") -->

<!-- ![western US](https://raw.github.com/jkmacc-LANL/pisces/dev/docs/pages/data/wUS.png "western US") -->

<p><img alt="western US" src="../data/wUS.png" />
<!-- <img alt="primary tables" src="https://raw.github.com/jkmacc-LANL/pisces/dev/docs/data/css3_primary.png" title="primary tables" /> --></p>
<h3 id="query-builders">Query-builders</h3>
<p>Pisces has a set of intuitive query-building functions for common
seismic queries in <code>pisces.request</code>.</p>
<pre class="prettyprint well"><code>import pisces.request as req

# repeat the previous query for a subset of western US earthquakes
wus_quakes = req.get_events(session, Origin, region=(-115, -105, 35, 45), mag={'mb': (4, None)})

# to sort by mb, ask for the query back and do your sort
wus_quakes = req.get_events(session, Origin, region=(-115, -105, 35, 45), mag={'mb': (4, None)}, asquery=True).order_by(Origin.mb).all()
</code></pre>
<p>Pisces uses NumPy/ObsPy to do distance subsets, which are done out-of-database and can be memory intensive. 
They can be done in-database, if you have a stored function "xkm_distance", for example, that calculates lateral distances.</p>
<pre class="prettyprint well"><code># stations &lt;= 200 km from lat 42, lon -110, out-of-database
sites = req.get_stations(session, Site, km=(42, -110, 0, 200))

# in-database "xkm_distance(lat1, lon1, lat2, lon2)" function
from sqlalchemy import func
sites = req.get_stations(session, Site, asquery=True).filter(func.xkm_distance(Site.lat, Site.lon, 42, -110).between(0, 200)).all()
</code></pre>
<h3 id="editing-tables">Editing tables</h3>
<pre class="prettyprint well"><code># add Albuquerque ANMO and the Chelyabinsk bolide
ANMO = Site(sta='ANMO', lat=34.9459, lon=-106.4572, elev=1.85)
bolide = Origin(orid=1, lat=55.15, lon=61.41, mb=2.7, etype='xm')
session.add_all([ANMO, bolide])
session.commit()

# edit a Site, delete an Origin
session.query(Site).filter(Site.sta == 'MK31').update({'lat': 42.5})
session.query(Origin).filter(Origin.orid = 1001).delete()
session.commit()
session.close()
</code></pre>
<p>Note that not all fields/attributes were specified when creating “ANMO”
or “bolide”, but their default values are filled in.</p>
<hr />
<h2 id="using-ids">Using ids</h2>
<hr />
<h2 id="copying-data-between-tables">Copying Data between Tables</h2>
<hr />
</div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/prettify-1.0.min.js"></script>
        <script src="../js/base.js"></script>
        
    </body>
</html>