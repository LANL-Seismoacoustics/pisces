<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Import/Export Waveforms - Pisces</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Import/Export Waveforms";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Pisces</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Tutorial</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../tutorial.tables/">Database Tables</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../tutorial.queries/">Using the Database</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Import/Export Waveforms</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#working-with-waveforms">Working with Waveforms</a></li>
                
                    <li><a class="toctree-l4" href="#introduction">Introduction</a></li>
                
                    <li><a class="toctree-l4" href="#retrieving-waves-from-a-query">Retrieving waves from a query</a></li>
                
                    <li><a class="toctree-l4" href="#adding-waveforms-to-the-database">Adding waveforms to the database</a></li>
                
                    <li><a class="toctree-l4" href="#copying-localizing-waveform-files">Copying (localizing) waveform files</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../tutorial.flatfiles/">Import/Export Flat Files</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../api/">API Documentation</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>About</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../about.roadmap/">Roadmap</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../about.license/">License</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../about.group/">User's Group</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Pisces</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Tutorial &raquo;</li>
        
      
    
    <li>Import/Export Waveforms</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/jkmacc-lanl/pisces" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="working-with-waveforms">Working with Waveforms</h1>
<p>How to read and write waveforms.</p>
<hr />
<h2 id="introduction">Introduction</h2>
<hr />
<h2 id="retrieving-waves-from-a-query">Retrieving waves from a query</h2>
<p>Waveforms are described in the <code>Wfdisc</code> table, and there are two ways to get waveforms from a query.</p>
<h3 id="read-directly-from-wfdisc-instances">Read directly from <code>wfdisc</code> instances</h3>
<p>If you have instances from the <code>Wfdisc</code> class, you can easily convert them to ObsPy <code>Trace</code>
instances for analysis or plotting.  Pisces Wfdisc class instances have a <code>to_trace</code> method,
which produces <code>Trace</code> instance from the <code>Wfdisc</code> instance.  Alternately, you can use the 
<code>wfdisc2trace</code> function on a vanilla SQLAlchemy Wfdisc instance (no <code>to_trace</code> method).
Finally, you can use the low-level function <code>read_waveform</code>, which underlies all the methods above.
This function returns a raw NumPy array instead of an Obspy Trace, however.</p>
<pre><code class="python">from mytables import Wfdisc
from pisces import wfdisc2trace, read_waveform


# loop over 10 BHZ wfdisc instances from the database
for wf in session.query(Wfdisc).filter(Wfdisc.chan == 'BHZ').limit(10):
    # the following two traces should be the same
    tr = wf.to_trace()
    tr = wfdisc2trace(wf) 

    # get the raw data
    data = read_waveform(wf.dir + '/' + wf.dfile, wf.datatype, wf.foff, wf.nsamp)

    #do analysis, writing, and/or plotting here...

</code></pre>

<h3 id="using-the-piscesclient-class">Using the <code>pisces.Client</code> class</h3>
<!--

The `Client` class is instantiated to point to a database, and relevant table names can be targeted
using the `load_tables` method.  Thereafter, the table classes are available in the instance's
`.tables` dictionary attribute.  In the following example, we retrieve windowed waveforms 
around predicted P and surface wave arrivals for some large events in 2010.


wzxhzdk:1

First, the client is instantiated with a database connection URL.
Next, the required station, event, and data tables are loaded with `load_tables`.
The `get_events` method is called to request events in 2010 with mb >= 5.4 that
are 30-90 epicentral degrees from latitude 40, longitude -105, returning a list
of Origin class instances (table rows). As the distance calculation is done
out-of-database, all events that match the other criteria are loaded first
before applying the distance filter. For large result sets, this can be
memory-intensive without an additional in-database filter, such as a region box
or smaller magnitude range. The `get_stations` method collects BHZ channels in
the western US, and returns a list of Site instances. Finally, we loop through
events and stations to predict a travel time window at each station using `travel_times` function, 
request the corresponding waveforms (as a collection of ObsPy Trace objects, called a `Stream`) 
using `get_waveform`, and write each trace to disc as a SAC file using the ObsPy Trace object write
method, which supports several output formats, including miniSEED.

-->

<hr />
<h2 id="adding-waveforms-to-the-database">Adding waveforms to the database</h2>
<p>Database-building scripts are in development, but adding waveforms to a database
is still relatively easy.  Using <a href="http://www.obspy.org">ObsPy</a>, any number of
waveform <a href="https://docs.obspy.org/packages/autogen/obspy.core.stream.read.html">formats</a>
can be read and the basic header "scraped" into a <code>Wfdisc</code> row.</p>
<p>Here's an example for a SAC file.</p>
<pre><code class="python">import os
from glob import glob

from obspy import read
from pisces import db_connect
from pisces.tables.css3 import Wfdisc


session = db_connect(conn='sqlite:///mydatabase.sqlite')

Wfdisc.__table__.create(session.bind)

FTYPE = 'SAC'

for ifile in glob(&quot;*.SAC&quot;):
   tr = read(ifile, format='SAC')[0]
   idir, idfile = os.path.split(ifile)
   wf = Wfdisc(sta=tr.stats.station, chan=tr.stats.channel, 
               samprate=tr.stats.sampling_rate, nsamp=tr.stats.npts, 
               time=tr.stats.starttime.timestamp, foff=634, dir=idir,
               dfile=idfile, endtime=tr.stats.endtime.timestamp)
   session.add(wf)

session.commit()
session.close()

</code></pre>

<hr />
<h2 id="copying-localizing-waveform-files">Copying (localizing) waveform files</h2>
<p>If you want to move waveform files from one database to another one, you may need copy the files
and tweak the Wfdisc table.  Wfdisc tables contain
file name and directory information about the waveforms stored on disk, so those need to be 
corrected when you move the files.  In the example below, we copy wfdisc instances from <code>session1</code>,
pointing to the originating database, to <code>session2</code>, which points at the destination database.</p>
<pre><code class="python">import os
import shutil

def copy_waves(wfdiscs, old_base, new_base):
    &quot;&quot;&quot;Replace old_base with new_base in the .dir attribute of wfdisc list, and copies the 
    waveform files to the new location.

    Parameters
    ----------
    wfdiscs : list
        Wfdisc instances from source database.
    old_base, new_base : str
        The top of the old (new) data directory trees.  This assumes all wfdiscs originate and 
        end up under single directories. The directory structure under the new_base will mirror
        that under old_base.

    Returns
    -------
    wfdiscs_out : list
        Same as input list, but .dir attribute now points to the new_base location.  

    &quot;&quot;&quot;
    for wf in wfdiscs:
        # replace the directory
        old_file =  os.path.sep.join([wf.dir, wf.dfile])
        wf.dir.replace(old_base, new_base)
        new_file =  os.path.sep.join([wf.dir, wf.dfile])
        try:
            shutil.copyfile(old_file, new_file)
        except IOError:
            # new directory doesn't exist yet.  this is like &quot;mkdir -p&quot; 
            os.makedirs(os.path.dirname(new_file))
            shutil.copyfile(old_file, new_file)

# get the wfdiscs
wfs = session1.query(Wfdisc1).all()

# release the link between the wfdiscs and the originating database
# this makes them &quot;floating&quot; instances, so they can be added to the destination database
session1.expunge_all(wfs)

# do the copy and tweaking
wfs = copy_waves(wfs, '/old/path/to/top/of/data', '/my/new/path/to/top/of/data')

# add and commit them to the destination database
session2.add_all(wfdiscs)
session2.commit()

</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../tutorial.flatfiles/" class="btn btn-neutral float-right" title="Import/Export Flat Files"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../tutorial.queries/" class="btn btn-neutral" title="Using the Database"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/jkmacc-lanl/pisces" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../tutorial.queries/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../tutorial.flatfiles/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
