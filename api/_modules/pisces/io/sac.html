<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pisces.io.sac &mdash; pisces 0.2.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="pisces 0.2.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pisces 0.2.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pisces.io.sac</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Conversions between SAC header variables and KB Core fields.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c">#XXX: currently not working</span>
<span class="c">#TODO: remove functions already in pisces.io.trace</span>
<span class="c">#TODO: make everything just translate dictionaries, not classes</span>
<span class="c">#TODO: change db.flatfile.KBTABLEDICT to use pisces.schema.util.get_infovals</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">from</span> <span class="nn">obspy.core</span> <span class="kn">import</span> <span class="n">UTCDateTime</span><span class="p">,</span> <span class="n">Trace</span><span class="p">,</span> <span class="n">Stats</span><span class="p">,</span> <span class="n">AttribDict</span>
<span class="kn">import</span> <span class="nn">obspy.core.util.geodetics</span> <span class="kn">as</span> <span class="nn">geod</span>

<span class="kn">import</span> <span class="nn">pisces.schema.kbcore</span> <span class="kn">as</span> <span class="nn">kb</span>
<span class="kn">from</span> <span class="nn">pisces.io.readwaveform</span> <span class="kn">import</span> <span class="n">read_waveform</span>
<span class="kn">from</span> <span class="nn">pisces.io.util</span> <span class="kn">import</span> <span class="n">_map_header</span><span class="p">,</span> <span class="n">_buildhdr</span>

<span class="c"># ObsPy default values</span>
<span class="n">OBSPYDEFAULT</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;network&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="s">&#39;station&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="s">&#39;location&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="s">&#39;channel&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">}</span>


<div class="viewcode-block" id="Site"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.Site">[docs]</a><span class="k">class</span> <span class="nc">Site</span><span class="p">(</span><span class="n">kb</span><span class="o">.</span><span class="n">Site</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;site&#39;</span>
</div>
<div class="viewcode-block" id="Sitechan"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.Sitechan">[docs]</a><span class="k">class</span> <span class="nc">Sitechan</span><span class="p">(</span><span class="n">kb</span><span class="o">.</span><span class="n">Sitechan</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;sitechan&#39;</span>
</div>
<div class="viewcode-block" id="Affiliation"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.Affiliation">[docs]</a><span class="k">class</span> <span class="nc">Affiliation</span><span class="p">(</span><span class="n">kb</span><span class="o">.</span><span class="n">Affiliation</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;affiliation&#39;</span>
</div>
<div class="viewcode-block" id="Instrument"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.Instrument">[docs]</a><span class="k">class</span> <span class="nc">Instrument</span><span class="p">(</span><span class="n">kb</span><span class="o">.</span><span class="n">Instrument</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;instrument&#39;</span>
</div>
<div class="viewcode-block" id="Origin"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.Origin">[docs]</a><span class="k">class</span> <span class="nc">Origin</span><span class="p">(</span><span class="n">kb</span><span class="o">.</span><span class="n">Origin</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;origin&#39;</span>
</div>
<div class="viewcode-block" id="Event"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.Event">[docs]</a><span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">kb</span><span class="o">.</span><span class="n">Event</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;event&#39;</span>
</div>
<div class="viewcode-block" id="Assoc"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.Assoc">[docs]</a><span class="k">class</span> <span class="nc">Assoc</span><span class="p">(</span><span class="n">kb</span><span class="o">.</span><span class="n">Assoc</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;assoc&#39;</span>
</div>
<div class="viewcode-block" id="Arrival"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.Arrival">[docs]</a><span class="k">class</span> <span class="nc">Arrival</span><span class="p">(</span><span class="n">kb</span><span class="o">.</span><span class="n">Arrival</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;arrival&#39;</span>
</div>
<div class="viewcode-block" id="Wfdisc"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.Wfdisc">[docs]</a><span class="k">class</span> <span class="nc">Wfdisc</span><span class="p">(</span><span class="n">kb</span><span class="o">.</span><span class="n">Wfdisc</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;wfdisc&#39;</span>

<span class="c"># ------------------ CONVERT SAC HEADER DICTIONARY TO TABLES ------------#</span>
<span class="c"># SAC default values</span></div>
<span class="n">IDEFAULT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">12345</span>
<span class="n">FDEFAULT</span> <span class="o">=</span> <span class="o">-</span><span class="mf">12345.0</span> 
<span class="n">SDEFAULT</span> <span class="o">=</span> <span class="s">&#39;-12345  &#39;</span>
<span class="n">SLDEFAULT</span> <span class="o">=</span> <span class="s">&#39;-12345          &#39;</span>
<span class="n">SACDEFAULT</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;az&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;baz&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span>
         <span class="s">&#39;cmpaz&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;cmpinc&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;delta&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;depmax&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;depmen&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;depmin&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;dist&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;e&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;evdp&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;evla&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;evlo&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;gcarc&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;idep&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;ievreg&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;ievtype&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;iftype&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;iinst&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;imagsrc&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;imagtyp&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span>
         <span class="s">&#39;int1&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;iqual&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;istreg&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;isynth&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;iztype&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;ka&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;kcmpnm&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kdatrd&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kevnm&#39;</span><span class="p">:</span> <span class="n">SLDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;kf&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;khole&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kinst&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span>
         <span class="s">&#39;knetwk&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;ko&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kstnm&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kt0&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span>
         <span class="s">&#39;kt1&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kt2&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kt3&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kt4&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span>
         <span class="s">&#39;kt5&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kt6&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kt7&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kt8&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span>
         <span class="s">&#39;kt9&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kuser0&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;kuser1&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;kuser2&#39;</span><span class="p">:</span> <span class="n">SDEFAULT</span><span class="p">,</span> <span class="s">&#39;lcalda&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;leven&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;lovrok&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;lpspol&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;mag&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;nevid&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;norid&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;npts&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;nvhdr&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;nwfid&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;nzhour&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;nzjday&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;nzmin&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;nzmsec&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span>
         <span class="s">&#39;nzsec&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;nzyear&#39;</span><span class="p">:</span> <span class="n">IDEFAULT</span><span class="p">,</span> <span class="s">&#39;o&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;odelta&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;scale&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;stdp&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;stel&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;stla&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;stlo&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;t0&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span>
         <span class="s">&#39;t1&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;t2&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;t3&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;t4&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;t5&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;t6&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;t7&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;t8&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;t9&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;unused10&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;unused11&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;unused12&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;unused6&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;unused7&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span>
         <span class="s">&#39;unused8&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;unused9&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;user0&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;user1&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;user2&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;user3&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;user4&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;user5&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;user6&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;user7&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;user8&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;user9&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span>
         <span class="s">&#39;xmaximum&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;xminimum&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> <span class="s">&#39;ymaximum&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">,</span> 
         <span class="s">&#39;yminimum&#39;</span><span class="p">:</span> <span class="n">FDEFAULT</span><span class="p">}</span>


<span class="c"># the following functions accept a SAC header dictionary, and return respective</span>
<span class="c"># kbcore table instances, assumes default SAC header values set to None</span>

<div class="viewcode-block" id="get_sac_reftime"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.get_sac_reftime">[docs]</a><span class="k">def</span> <span class="nf">get_sac_reftime</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get UTCDateTime object from sac header dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># &quot;nz&quot; fields are not kept when ObsPy reads a SAC file.  They&#39;re used </span>
    <span class="c"># to make &quot;starttime&quot;, then discarded.</span>
    <span class="c"># t0 = nzyear + nzjday + nzhour + nzminute + nzsecond + nzmsec*1000</span>
    <span class="c"># starttime = t0 + b</span>
    <span class="c"># therefore: t0 = starttime - b</span>
    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">b</span> <span class="ow">is</span> <span class="n">SACDEFAULT</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">]:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">b</span>

    <span class="k">return</span> <span class="n">t0</span>
</div>
<div class="viewcode-block" id="sachdr2reftime"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.sachdr2reftime">[docs]</a><span class="k">def</span> <span class="nf">sachdr2reftime</span><span class="p">(</span><span class="n">hdr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get SAC reference UTCDateTime from header dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># reftime = nzyear + nzjday + nzhour + nzminute + nzsecond + nzmsec*1000</span>
    <span class="n">tdict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;year&#39;</span><span class="p">:</span> <span class="mi">1970</span><span class="p">,</span> <span class="s">&#39;month&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;day&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;minute&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;microsecond&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="c"># for non-default values in hdr, return desired values, mapped to new keys</span>
    <span class="n">mapdict</span> <span class="o">=</span> <span class="n">_map_header</span><span class="p">({</span><span class="s">&#39;nzyear&#39;</span><span class="p">:</span> <span class="s">&#39;year&#39;</span><span class="p">,</span> <span class="s">&#39;nzjday&#39;</span><span class="p">:</span><span class="s">&#39;julday&#39;</span><span class="p">,</span> <span class="s">&#39;nzhour&#39;</span><span class="p">:</span><span class="s">&#39;hour&#39;</span><span class="p">,</span> 
                           <span class="s">&#39;nzmin&#39;</span><span class="p">:</span><span class="s">&#39;minute&#39;</span><span class="p">,</span> <span class="s">&#39;nzsec&#39;</span><span class="p">:</span><span class="s">&#39;second&#39;</span><span class="p">,</span> 
                           <span class="s">&#39;nzmsec&#39;</span><span class="p">:</span><span class="s">&#39;microsecond&#39;</span><span class="p">},</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">SACDEFAULT</span><span class="p">)</span>
    <span class="n">tdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mapdict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tdict</span><span class="p">[</span><span class="s">&#39;microsecond&#39;</span><span class="p">]:</span>
        <span class="n">tdict</span><span class="p">[</span><span class="s">&#39;microsecond&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1000.</span>
    
    <span class="c">#tdict = {}</span>
    <span class="c">#tdict.update((key, val) for key, val in tmpdict.iteritems() \</span>
    <span class="c">#        if val is not None)</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="o">**</span><span class="n">tdict</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="tr2site"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.tr2site">[docs]</a><span class="k">def</span> <span class="nf">tr2site</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provide an ObsPy Trace, get a filled site table instance, using available</span>
<span class="sd">    header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sitedict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c">#1) from obspy header first</span>
    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
        <span class="n">sitedict</span><span class="p">[</span><span class="s">&#39;sta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>

    <span class="c">#2) get from sac header</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sac2site</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;stla&#39;</span><span class="p">:</span> <span class="s">&#39;lat&#39;</span><span class="p">,</span> <span class="s">&#39;stlo&#39;</span><span class="p">:</span> <span class="s">&#39;lon&#39;</span><span class="p">,</span> <span class="s">&#39;stel&#39;</span><span class="p">:</span> <span class="s">&#39;elev&#39;</span><span class="p">}</span>
        <span class="n">sitedict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_map_header</span><span class="p">(</span><span class="n">sac2site</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">,</span> <span class="n">SACDEFAULT</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>            
            <span class="n">sitedict</span><span class="p">[</span><span class="s">&#39;elev&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="mi">1000</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c">#no &#39;elev&#39; </span>
            <span class="k">pass</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="c"># tr.stats has no &quot;sac&quot; attribute</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">sitedict</span><span class="p">:</span>
        <span class="n">site</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="o">**</span><span class="n">sitedict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">site</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">site</span>

</div>
<div class="viewcode-block" id="tr2sitechan"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.tr2sitechan">[docs]</a><span class="k">def</span> <span class="nf">tr2sitechan</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide a sac header dictionary, get a filled sitechan table instance.&quot;&quot;&quot;</span>

    <span class="c">#1) from obspy header</span>
    <span class="n">sitechandict</span> <span class="o">=</span> <span class="n">_map_header</span><span class="p">({</span><span class="s">&#39;station&#39;</span><span class="p">:</span> <span class="s">&#39;sta&#39;</span><span class="p">,</span> <span class="s">&#39;channel&#39;</span><span class="p">:</span> <span class="s">&#39;chan&#39;</span><span class="p">},</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> 
                                <span class="n">OBSPYDEFAULT</span><span class="p">)</span>

    <span class="c">#2) from sac header</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sac2sitechan</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;cmpaz&#39;</span><span class="p">:</span> <span class="s">&#39;hang&#39;</span><span class="p">,</span> <span class="s">&#39;cmpinc&#39;</span><span class="p">:</span> <span class="s">&#39;vang&#39;</span><span class="p">,</span> <span class="s">&#39;stdp&#39;</span><span class="p">:</span> <span class="s">&#39;edepth&#39;</span><span class="p">}</span>
        <span class="n">sitechandict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_map_header</span><span class="p">(</span><span class="n">sac2sitechan</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">,</span> <span class="n">SACDEFAULT</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>           
            <span class="n">sitechandict</span><span class="p">[</span><span class="s">&#39;edepth&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">1000.</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="c">#edepth is None or missing</span>
            <span class="k">pass</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="c"># no tr.stats.sac</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">sitechandict</span><span class="p">:</span>
        <span class="n">sitechan</span> <span class="o">=</span> <span class="n">Sitechan</span><span class="p">(</span><span class="o">**</span><span class="n">sitechandict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sitechan</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">sitechan</span>
    
</div>
<div class="viewcode-block" id="tr2affiliation"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.tr2affiliation">[docs]</a><span class="k">def</span> <span class="nf">tr2affiliation</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="c">#1) from obspy header</span>
    <span class="n">affildict</span> <span class="o">=</span> <span class="n">_map_header</span><span class="p">({</span><span class="s">&#39;network&#39;</span><span class="p">:</span> <span class="s">&#39;net&#39;</span><span class="p">,</span> <span class="s">&#39;station&#39;</span><span class="p">:</span> <span class="s">&#39;sta&#39;</span><span class="p">},</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span>
                             <span class="n">OBSPYDEFAULT</span><span class="p">)</span>

    <span class="c">#2) from sac header</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sac2affiliation</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;knetwk&#39;</span><span class="p">:</span> <span class="s">&#39;net&#39;</span><span class="p">,</span> <span class="s">&#39;kstnm&#39;</span><span class="p">:</span> <span class="s">&#39;sta&#39;</span><span class="p">}</span>
        <span class="n">affildict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_map_header</span><span class="p">(</span><span class="n">sac2affiliation</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">,</span> <span class="n">SACDEFAULT</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="c"># no tr.stats.sac or &#39;knetwk&#39;, etc.</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">affildict</span><span class="p">:</span>
        <span class="n">affil</span> <span class="o">=</span> <span class="n">Affiliation</span><span class="p">(</span><span class="o">**</span><span class="n">affildict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">affil</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">affil</span>

</div>
<div class="viewcode-block" id="tr2instrument"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.tr2instrument">[docs]</a><span class="k">def</span> <span class="nf">tr2instrument</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="c">#TODO: investigate hdr[&#39;resp0-9&#39;] values</span>
    <span class="c">#1) from sac header</span>
    <span class="n">instrdict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;samprate&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">instrdict</span> <span class="o">=</span> <span class="n">_map_header</span><span class="p">({</span><span class="s">&#39;kinst&#39;</span><span class="p">:</span> <span class="s">&#39;ins&#39;</span><span class="p">,</span> <span class="s">&#39;iinst&#39;</span><span class="p">:</span> <span class="s">&#39;instype&#39;</span><span class="p">},</span> 
                                <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">,</span> <span class="n">SACDEFAULT</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c">#no tr.stats.sac</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">instrdict</span><span class="p">:</span>
        <span class="n">instr</span> <span class="o">=</span> <span class="n">Instrument</span><span class="p">(</span><span class="o">**</span><span class="n">instrdict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">instr</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">instr</span>

</div>
<div class="viewcode-block" id="tr2origin"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.tr2origin">[docs]</a><span class="k">def</span> <span class="nf">tr2origin</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provide a sac header dictionary, get a filled origin table instance.</span>
<span class="sd">    A few things:</span>
<span class="sd">    1) If sac reference time isn&#39;t event-based, origin time is unknown</span>
<span class="sd">    2) magnitude is taken first from hdr[&#39;mag&#39;], hdr[&#39;imagtyp&#39;] if defined,</span>
<span class="sd">       then replaced by hdr[&#39;user0&#39;],hdr[&#39;kuser0&#39;]</span>
<span class="sd">    3) sac moment, duration, and user-defined magnitude headers aren&#39;t</span>
<span class="sd">       put into the origin table</span>
<span class="sd">    4) origin.auth is taken first from hdr[&#39;imagsrc&#39;], then replaced by</span>
<span class="sd">       hdr[&#39;kuser1&#39;] if defined.  the imagsrc-&gt;auth translations are:</span>

<span class="sd">     * INEIC -&gt; ISC:NEIC</span>
<span class="sd">     * IPDE -&gt; PDE</span>
<span class="sd">     * IISC -&gt; ISC</span>
<span class="sd">     * IBRK -&gt; ISC:BERK</span>
<span class="sd">     * IUSGS, ICALTECH, ILLNL, IEVLOC, IJSOP, IUSER, IUNKNOWN -&gt; unchanged </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># simple SAC translations</span>
    <span class="n">sac2origin</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;evla&#39;</span><span class="p">:</span> <span class="s">&#39;lat&#39;</span><span class="p">,</span> <span class="s">&#39;evlo&#39;</span><span class="p">:</span> <span class="s">&#39;lon&#39;</span><span class="p">,</span> <span class="s">&#39;norid&#39;</span><span class="p">:</span> <span class="s">&#39;orid&#39;</span><span class="p">,</span> 
                  <span class="s">&#39;nevid&#39;</span><span class="p">:</span> <span class="s">&#39;evid&#39;</span><span class="p">,</span> <span class="s">&#39;ievreg&#39;</span><span class="p">:</span> <span class="s">&#39;grn&#39;</span><span class="p">,</span> <span class="s">&#39;evdp&#39;</span><span class="p">:</span> <span class="s">&#39;depth&#39;</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">origindict</span> <span class="o">=</span> <span class="n">_map_header</span><span class="p">(</span><span class="n">sac2origin</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">,</span> <span class="n">SACDEFAULT</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c">#no tr.stats.sac</span>
        <span class="k">pass</span>

    <span class="c">#depth</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">origindict</span><span class="p">[</span><span class="s">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="s">&#39;evdp&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1000.</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
        <span class="c">#evdp is None, or no tr.stats.sac</span>
        <span class="k">pass</span>

    <span class="c">#etype translations</span>
    <span class="n">edict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">37</span><span class="p">:</span> <span class="s">&#39;en&#39;</span><span class="p">,</span> <span class="mi">38</span><span class="p">:</span> <span class="s">&#39;ex&#39;</span><span class="p">,</span> <span class="mi">39</span><span class="p">:</span> <span class="s">&#39;ex&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">:</span> <span class="s">&#39;qt&#39;</span><span class="p">,</span> <span class="mi">41</span><span class="p">:</span> <span class="s">&#39;qt&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">:</span> <span class="s">&#39;qt&#39;</span><span class="p">,</span> 
            <span class="mi">43</span><span class="p">:</span> <span class="s">&#39;ec&#39;</span><span class="p">,</span> <span class="mi">72</span><span class="p">:</span> <span class="s">&#39;me&#39;</span><span class="p">,</span> <span class="mi">73</span><span class="p">:</span> <span class="s">&#39;me&#39;</span><span class="p">,</span> <span class="mi">74</span><span class="p">:</span> <span class="s">&#39;me&#39;</span><span class="p">,</span> <span class="mi">75</span><span class="p">:</span> <span class="s">&#39;me&#39;</span><span class="p">,</span> <span class="mi">76</span><span class="p">:</span> <span class="s">&#39;mb&#39;</span><span class="p">,</span>
            <span class="mi">77</span><span class="p">:</span> <span class="s">&#39;qt&#39;</span><span class="p">,</span> <span class="mi">78</span><span class="p">:</span> <span class="s">&#39;qt&#39;</span><span class="p">,</span> <span class="mi">79</span><span class="p">:</span> <span class="s">&#39;qt&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">:</span> <span class="s">&#39;ex&#39;</span><span class="p">,</span> <span class="mi">81</span><span class="p">:</span> <span class="s">&#39;ex&#39;</span><span class="p">,</span> <span class="mi">82</span><span class="p">:</span> <span class="s">&#39;en&#39;</span><span class="p">,</span>
            <span class="mi">83</span><span class="p">:</span> <span class="s">&#39;mc&#39;</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">origindict</span><span class="p">[</span><span class="s">&#39;etype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edict</span><span class="p">[</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="s">&#39;ievtype&#39;</span><span class="p">]]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="c">#ievtyp is None, or not a key in edict (e.g. sac default value)</span>
        <span class="k">pass</span>

    <span class="c">#1: </span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">get_sac_reftime</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="s">&#39;iztype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
            <span class="c">#reference time is an origin time</span>
            <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">o</span> <span class="ow">is</span> <span class="n">SACDEFAULT</span><span class="p">[</span><span class="s">&#39;o&#39;</span><span class="p">]:</span>
                <span class="n">o</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">o</span>
            <span class="n">origindict</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">o</span>
            <span class="n">origindict</span><span class="p">[</span><span class="s">&#39;jdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">t</span><span class="o">-</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y%j&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="c"># no trace.stats.sac, no iztype</span>
        <span class="k">pass</span>

    <span class="c">#2: magnitude</span>
    <span class="n">magdict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">52</span><span class="p">:</span> <span class="s">&#39;mb&#39;</span><span class="p">,</span> <span class="mi">53</span><span class="p">:</span> <span class="s">&#39;ms&#39;</span><span class="p">,</span> <span class="mi">54</span><span class="p">:</span> <span class="s">&#39;ml&#39;</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">origindict</span><span class="p">[</span><span class="n">magdict</span><span class="p">[</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="s">&#39;imagtyp&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="s">&#39;mag&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c">#imagtyp is None or not a key in magdict</span>
        <span class="k">pass</span>

    <span class="c"># is kuser0 is a recognized magnitude type, overwrite mag</span>
    <span class="c">#XXX: this is a LANL wfdisc2sac thing</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">magtype</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="s">&#39;kuser0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">magtype</span> <span class="ow">in</span> <span class="n">magdict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">origindict</span><span class="p">[</span><span class="n">magtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="s">&#39;user0&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c">#kuser0 is None</span>
        <span class="k">pass</span>

    <span class="c">#3: origin author</span>
    <span class="n">authdict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">58</span><span class="p">:</span> <span class="s">&#39;ISC:NEIC&#39;</span><span class="p">,</span> <span class="mi">61</span><span class="p">:</span> <span class="s">&#39;PDE&#39;</span><span class="p">,</span> <span class="mi">62</span><span class="p">:</span> <span class="s">&#39;ISC&#39;</span><span class="p">,</span> <span class="mi">63</span><span class="p">:</span> <span class="s">&#39;REB-ICD&#39;</span><span class="p">,</span> 
            <span class="mi">64</span><span class="p">:</span> <span class="s">&#39;IUSGS&#39;</span><span class="p">,</span> <span class="mi">65</span><span class="p">:</span> <span class="s">&#39;ISC:BERK&#39;</span><span class="p">,</span> <span class="mi">66</span><span class="p">:</span> <span class="s">&#39;ICALTECH&#39;</span><span class="p">,</span> <span class="mi">67</span><span class="p">:</span> <span class="s">&#39;ILLNL&#39;</span><span class="p">,</span>
            <span class="mi">68</span><span class="p">:</span> <span class="s">&#39;IEVLOC&#39;</span><span class="p">,</span> <span class="mi">69</span><span class="p">:</span> <span class="s">&#39;IJSOP&#39;</span><span class="p">,</span> <span class="mi">70</span><span class="p">:</span> <span class="s">&#39;IUSER&#39;</span><span class="p">,</span> <span class="mi">71</span><span class="p">:</span> <span class="s">&#39;IUNKNOWN&#39;</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">origindict</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">authdict</span><span class="p">[</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="s">&#39;imagsrc&#39;</span><span class="p">]]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c"># imagsrc not in authdict (i.e. sac default value)</span>
        <span class="k">pass</span>

    <span class="c">#XXX: this is LANL wfdisc2sac thing.  maybe turn it off?</span>
    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="s">&#39;kuser1&#39;</span><span class="p">]:</span>
        <span class="n">origindict</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="s">&#39;kuser1&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">origindict</span><span class="p">:</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">Origin</span><span class="p">(</span><span class="o">**</span><span class="n">origindict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">origin</span>

</div>
<div class="viewcode-block" id="tr2event"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.tr2event">[docs]</a><span class="k">def</span> <span class="nf">tr2event</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="n">eventdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">eventdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_map_header</span><span class="p">({</span><span class="s">&#39;nevid&#39;</span><span class="p">:</span> <span class="s">&#39;evid&#39;</span><span class="p">,</span> <span class="s">&#39;kevnm&#39;</span><span class="p">:</span> <span class="s">&#39;evname&#39;</span><span class="p">},</span>
                                <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">,</span> <span class="n">SACDEFAULT</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c">#no tr.stats.sac</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">eventdict</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="o">**</span><span class="n">eventdict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">event</span>

</div>
<div class="viewcode-block" id="tr2assoc"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.tr2assoc">[docs]</a><span class="k">def</span> <span class="nf">tr2assoc</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">pickmap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a sac header dictionary, and produces a list of up to 10 </span>
<span class="sd">    Assoc instances. Header-&gt;phase mappings follow SAC2000, i.e.:</span>

<span class="sd">    * t0: P</span>
<span class="sd">    * t1: Pn</span>
<span class="sd">    * t2: Pg</span>
<span class="sd">    * t3: S</span>
<span class="sd">    * t4: Sn</span>
<span class="sd">    * t5: Sg</span>
<span class="sd">    * t6: Lg</span>
<span class="sd">    * t7: LR</span>
<span class="sd">    * t8: Rg</span>
<span class="sd">    * t9: pP</span>

<span class="sd">    An alternate mapping for some or all picks can be supplied, however, </span>
<span class="sd">    as a dictionary of strings in the above form.  </span>
<span class="sd">    </span>
<span class="sd">    Note: arid values will not be filled in, so do:</span>
<span class="sd">    &gt;&gt;&gt; for assoc in kbio.tables[&#39;assoc&#39;]:</span>
<span class="sd">            assoc.arid = lastarid+1</span>
<span class="sd">            lastarid += 1</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pick2phase</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;t0&#39;</span><span class="p">:</span> <span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="s">&#39;t1&#39;</span><span class="p">:</span> <span class="s">&#39;Pn&#39;</span><span class="p">,</span> <span class="s">&#39;t2&#39;</span><span class="p">:</span> <span class="s">&#39;Pg&#39;</span><span class="p">,</span> <span class="s">&#39;t3&#39;</span><span class="p">:</span> <span class="s">&#39;S&#39;</span><span class="p">,</span>
    <span class="s">&#39;t4&#39;</span><span class="p">:</span> <span class="s">&#39;Sn&#39;</span><span class="p">,</span> <span class="s">&#39;t5&#39;</span><span class="p">:</span> <span class="s">&#39;Sg&#39;</span><span class="p">,</span> <span class="s">&#39;t6&#39;</span><span class="p">:</span> <span class="s">&#39;Lg&#39;</span><span class="p">,</span> <span class="s">&#39;t7&#39;</span><span class="p">:</span> <span class="s">&#39;LR&#39;</span><span class="p">,</span> <span class="s">&#39;t8&#39;</span><span class="p">:</span> <span class="s">&#39;Rg&#39;</span><span class="p">,</span>
    <span class="s">&#39;t9&#39;</span><span class="p">:</span> <span class="s">&#39;pP&#39;</span><span class="p">}</span> 

    <span class="c">#overwrite defaults with supplied map</span>
    <span class="k">if</span> <span class="n">pickmap</span><span class="p">:</span>
        <span class="n">pick2phase</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pickmap</span><span class="p">)</span>

    <span class="c">#geographic relations</span>
    <span class="c"># obspy.read tries to calculate these values if lcalca is True and needed</span>
    <span class="c">#header info is there, so we only need to try to if lcalca is False.</span>
    <span class="c">#XXX: I just calculate it if no values are currently filled in.</span>
    <span class="n">assocdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">assocdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_map_header</span><span class="p">({</span><span class="s">&#39;az&#39;</span><span class="p">:</span> <span class="s">&#39;esaz&#39;</span><span class="p">,</span> <span class="s">&#39;baz&#39;</span><span class="p">:</span> <span class="s">&#39;seaz&#39;</span><span class="p">,</span> 
                                      <span class="s">&#39;gcarc&#39;</span><span class="p">:</span> <span class="s">&#39;delta&#39;</span><span class="p">},</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">,</span> 
                                      <span class="n">SACDEFAULT</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c"># no tr.stats.sac</span>
        <span class="k">pass</span>

    <span class="c">#overwrite if any are None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">assocdict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">locations2degrees</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">stla</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">stlo</span><span class="p">,</span> 
                                           <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">evla</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">evlo</span><span class="p">)</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">seaz</span><span class="p">,</span> <span class="n">esaz</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">gps2DistAzimuth</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">stla</span><span class="p">,</span> 
                <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">stlo</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">evla</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="o">.</span><span class="n">evlo</span><span class="p">)</span>
            <span class="n">assocdict</span><span class="p">[</span><span class="s">&#39;esaz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">esaz</span>
            <span class="n">assocdict</span><span class="p">[</span><span class="s">&#39;seaz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seaz</span>
            <span class="n">assocdict</span><span class="p">[</span><span class="s">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="c">#some sac header values are None</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
        <span class="n">assocdict</span><span class="p">[</span><span class="s">&#39;sta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>

    <span class="n">assocdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_map_header</span><span class="p">({</span><span class="s">&#39;norid&#39;</span><span class="p">:</span> <span class="s">&#39;orid&#39;</span><span class="p">},</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">,</span> <span class="n">SACDEFAULT</span><span class="p">))</span>

    <span class="c">#now, do the phase arrival mappings</span>
    <span class="c">#for each pick in hdr, make a separate dictionary containing assocdict plus</span>
    <span class="c">#the new phase info.</span>
    <span class="n">assocs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pick2phase</span><span class="p">:</span>
        <span class="n">kkey</span> <span class="o">=</span> <span class="s">&#39;k&#39;</span> <span class="o">+</span> <span class="n">key</span>
        <span class="c">#if there&#39;s a value in t[0-9]</span>
        <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SACDEFAULT</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="c">#if the phase name kt[0-9] is null</span>
            <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="n">kkey</span><span class="p">]</span> <span class="o">==</span> <span class="n">SACDEFAULT</span><span class="p">[</span><span class="n">kkey</span><span class="p">]:</span>
                <span class="c">#take it from the map</span>
                <span class="n">iassoc</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;phase&#39;</span><span class="p">:</span> <span class="n">pick2phase</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#take it directly</span>
                <span class="n">iassoc</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;phase&#39;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="n">kkey</span><span class="p">]}</span>

            <span class="n">iassoc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">assocdict</span><span class="p">)</span>
            <span class="n">assocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iassoc</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">Assoc</span><span class="p">(</span><span class="o">**</span><span class="n">assoc</span><span class="p">)</span> <span class="k">for</span> <span class="n">assoc</span> <span class="ow">in</span> <span class="n">assocs</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="tr2arrival"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.tr2arrival">[docs]</a><span class="k">def</span> <span class="nf">tr2arrival</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">pickmap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Similar to tr2assoc, but produces a list of up to 10 Arrival</span>
<span class="sd">    instances.  Same header-&gt;phase mapping applies, unless otherwise stated.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#puts t[0-9] times into arrival.time if they&#39;re not null</span>
    <span class="c">#puts corresponding kt[0-9] phase name into arrival.iphase</span>
    <span class="c">#if a kt[0-9] phase name is null and its t[0-9] values isn&#39;t,</span>
    <span class="c">#phase names are pulled from the pick2phase dictionary</span>
    <span class="n">pick2phase</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;t0&#39;</span><span class="p">:</span> <span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="s">&#39;t1&#39;</span><span class="p">:</span> <span class="s">&#39;Pn&#39;</span><span class="p">,</span> <span class="s">&#39;t2&#39;</span><span class="p">:</span> <span class="s">&#39;Pg&#39;</span><span class="p">,</span> <span class="s">&#39;t3&#39;</span><span class="p">:</span> <span class="s">&#39;S&#39;</span><span class="p">,</span>
    <span class="s">&#39;t4&#39;</span><span class="p">:</span> <span class="s">&#39;Sn&#39;</span><span class="p">,</span> <span class="s">&#39;t5&#39;</span><span class="p">:</span> <span class="s">&#39;Sg&#39;</span><span class="p">,</span> <span class="s">&#39;t6&#39;</span><span class="p">:</span> <span class="s">&#39;Lg&#39;</span><span class="p">,</span> <span class="s">&#39;t7&#39;</span><span class="p">:</span> <span class="s">&#39;LR&#39;</span><span class="p">,</span> <span class="s">&#39;t8&#39;</span><span class="p">:</span> <span class="s">&#39;Rg&#39;</span><span class="p">,</span>
    <span class="s">&#39;t9&#39;</span><span class="p">:</span> <span class="s">&#39;pP&#39;</span><span class="p">}</span> 

    <span class="k">if</span> <span class="n">pickmap</span><span class="p">:</span>
        <span class="n">pick2phase</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pickmap</span><span class="p">)</span>

    <span class="c">#simple translations</span>
    <span class="n">arrivaldict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
        <span class="n">arrivaldict</span><span class="p">[</span><span class="s">&#39;sta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">:</span>
        <span class="n">arrivaldict</span><span class="p">[</span><span class="s">&#39;chan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span>

    <span class="c">#phases and arrival times</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">get_sac_reftime</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="n">arrivals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pick2phase</span><span class="p">:</span>
        <span class="n">kkey</span> <span class="o">=</span> <span class="s">&#39;k&#39;</span> <span class="o">+</span> <span class="n">key</span>
        <span class="c"># if there&#39;s a value in t[0-9]</span>
        <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SACDEFAULT</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">itime</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">iarrival</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="n">itime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                        <span class="s">&#39;jdate&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">itime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y%j&#39;</span><span class="p">))}</span>
            <span class="c">#if the phase name kt[0-9] is null</span>
            <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="n">kkey</span><span class="p">]</span> <span class="o">==</span> <span class="n">SACDEFAULT</span><span class="p">[</span><span class="n">kkey</span><span class="p">]:</span>
                <span class="c">#take it from the pick2phase map</span>
                <span class="n">iarrival</span><span class="p">[</span><span class="s">&#39;iphase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pick2phase</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#take it directly</span>
                <span class="n">iarrival</span><span class="p">[</span><span class="s">&#39;iphase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">[</span><span class="n">kkey</span><span class="p">]</span>

            <span class="n">iarrival</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arrivaldict</span><span class="p">)</span>
            <span class="n">arrivals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iassoc</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">Arrival</span><span class="p">(</span><span class="o">**</span><span class="n">arrival</span><span class="p">)</span> <span class="k">for</span> <span class="n">arrival</span> <span class="ow">in</span> <span class="n">arrivals</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="tr2wfdisc"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.tr2wfdisc">[docs]</a><span class="k">def</span> <span class="nf">tr2wfdisc</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Produce wfdisc kbcore table instance from sac header dictionary.</span>
<span class="sd">    Clearly this will be a skeleton instance, as the all-important &#39;dir&#39; and </span>
<span class="sd">    &#39;dfile&#39; must be filled in later.</span>

<span class="sd">    Note: if you read a little-endian SAC file onto a big-endian machine, it</span>
<span class="sd">    seems that obspy.sac.sacio.SacIO.swap_byte_order has trouble.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># from obspy header</span>
    <span class="n">wfdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">wfdict</span><span class="p">[</span><span class="s">&#39;nsamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span>
    <span class="n">wfdict</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">timestamp</span>
    <span class="n">wfdict</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">timestamp</span>
    <span class="n">wfdict</span><span class="p">[</span><span class="s">&#39;jdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y%j&#39;</span><span class="p">))</span>
    <span class="n">wfdict</span><span class="p">[</span><span class="s">&#39;samprate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
        <span class="n">wfdict</span><span class="p">[</span><span class="s">&#39;sta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">:</span> 
        <span class="n">wfdict</span><span class="p">[</span><span class="s">&#39;chan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span>
    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">calib</span><span class="p">:</span>
        <span class="n">wfdict</span><span class="p">[</span><span class="s">&#39;calib&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">calib</span>

    <span class="c">#from sac header</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">wfdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_map_header</span><span class="p">({</span><span class="s">&#39;nwfid&#39;</span><span class="p">:</span> <span class="s">&#39;wfid&#39;</span><span class="p">},</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sac</span><span class="p">,</span> <span class="n">SACDEFAULT</span><span class="p">))</span>
        <span class="n">wfdict</span><span class="p">[</span><span class="s">&#39;foff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">634</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s">&#39;little&#39;</span><span class="p">:</span>
            <span class="n">wfdict</span><span class="p">[</span><span class="s">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;f4&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wfdict</span><span class="p">[</span><span class="s">&#39;datatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;t4&#39;</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c">#no tr.stats.sac</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">Wfdisc</span><span class="p">(</span><span class="o">**</span><span class="n">wfdict</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="trace2tables"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.trace2tables">[docs]</a><span class="k">def</span> <span class="nf">trace2tables</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s">&#39;kbcore&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scrape ObsPy Trace headers into database table dictionary.</span>
<span class="sd">    Null values in Trace headers are not returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tr: Obspy.core.Trace</span>
<span class="sd">    tables: list, optional</span>
<span class="sd">        Table name strings to return. </span>
<span class="sd">        Default, [&#39;affiliation&#39;, &#39;arrival&#39;, &#39;assoc&#39;, &#39;event&#39;, &#39;instrument&#39;,</span>
<span class="sd">        &#39;origin&#39;, &#39;site&#39;, &#39;sitechan&#39;, &#39;wfdisc&#39;]</span>
<span class="sd">    schema: string, optional</span>
<span class="sd">        &#39;kbcore&#39; or &#39;css&#39;.  Default: &#39;kbcore&#39;</span>
<span class="sd">        ***Not yet implemented***</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary of table objects.  tables[&#39;arrival&#39;] and tables[&#39;assoc&#39;]</span>
<span class="sd">        return (possibly empty) _lists_ of table objects.  If only default </span>
<span class="sd">        values are found for a table, it is omitted.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Some things must be checked or filled in before adding to a database:</span>
<span class="sd">    - affiliation.time, endtime</span>
<span class="sd">    - arrival.arid</span>
<span class="sd">    - assoc.orid, arid</span>
<span class="sd">    - event.prefor, evid</span>
<span class="sd">    - instrument.inid, dir, dfile, rsptype</span>
<span class="sd">    - site.ondate</span>
<span class="sd">    - sitechan.ondate, chanid</span>
<span class="sd">    - wfdisc.dir, dfile, foff, datetype, wfid</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fns</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;affiliation&#39;</span><span class="p">:</span> <span class="n">tr2affiliation</span><span class="p">,</span>
           <span class="s">&#39;arrival&#39;</span><span class="p">:</span> <span class="n">tr2arrival</span><span class="p">,</span>
           <span class="s">&#39;assoc&#39;</span><span class="p">:</span> <span class="n">tr2assoc</span><span class="p">,</span>
           <span class="s">&#39;event&#39;</span><span class="p">:</span> <span class="n">tr2event</span><span class="p">,</span>
           <span class="s">&#39;instrument&#39;</span><span class="p">:</span> <span class="n">tr2instrument</span><span class="p">,</span>
           <span class="s">&#39;origin&#39;</span><span class="p">:</span> <span class="n">tr2origin</span><span class="p">,</span>
           <span class="s">&#39;site&#39;</span><span class="p">:</span> <span class="n">tr2site</span><span class="p">,</span>
           <span class="s">&#39;sitechan&#39;</span><span class="p">:</span> <span class="n">tr2sitechan</span><span class="p">,</span>
           <span class="s">&#39;wfdisc&#39;</span><span class="p">:</span> <span class="n">tr2wfdisc</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">tables</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="n">fns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">AttribDict</span><span class="p">()</span>
    <span class="c">#for table, fn in fns.iteritems():</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">ifn</span> <span class="o">=</span> <span class="n">fns</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
        <span class="n">itab</span> <span class="o">=</span> <span class="n">ifn</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">itab</span><span class="p">:</span>
            <span class="n">t</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifn</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">t</span>


<span class="c">#----------------- CONVERT TABLES TO SAC HEADER DICTIONARY ---------------#</span>
<span class="c">#TODO: make these functions able to gracefully handle None values as inputs</span></div>
<div class="viewcode-block" id="site2sachdr"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.site2sachdr">[docs]</a><span class="k">def</span> <span class="nf">site2sachdr</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accepts a fielded site table row and returns a dictionary of corresponding</span>
<span class="sd">    sac header field/value pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keymap</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;stel&#39;</span><span class="p">:</span> <span class="s">&#39;elev&#39;</span><span class="p">,</span> <span class="s">&#39;stal&#39;</span><span class="p">:</span> <span class="s">&#39;lat&#39;</span><span class="p">,</span> <span class="s">&#39;stlo&#39;</span><span class="p">:</span> <span class="s">&#39;lon&#39;</span><span class="p">}</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">_buildhdr</span><span class="p">(</span><span class="n">keymap</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hdr</span>
</div>
<div class="viewcode-block" id="sitechan2sachdr"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.sitechan2sachdr">[docs]</a><span class="k">def</span> <span class="nf">sitechan2sachdr</span><span class="p">(</span><span class="n">sc</span><span class="p">):</span>
    <span class="n">keymap</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;cmpaz&#39;</span><span class="p">:</span> <span class="s">&#39;hang&#39;</span><span class="p">,</span> <span class="s">&#39;cmpinc&#39;</span><span class="p">:</span> <span class="s">&#39;vang&#39;</span><span class="p">}</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">_buildhdr</span><span class="p">(</span><span class="n">keymap</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hdr</span>
</div>
<div class="viewcode-block" id="affiliation2sachdr"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.affiliation2sachdr">[docs]</a><span class="k">def</span> <span class="nf">affiliation2sachdr</span><span class="p">(</span><span class="n">af</span><span class="p">):</span>
    <span class="n">keymap</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;network&#39;</span><span class="p">:</span> <span class="s">&#39;net&#39;</span><span class="p">}</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">_buildhdr</span><span class="p">(</span><span class="n">keymap</span><span class="p">,</span> <span class="n">af</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hdr</span>
</div>
<div class="viewcode-block" id="instrument2sachdr"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.instrument2sachdr">[docs]</a><span class="k">def</span> <span class="nf">instrument2sachdr</span><span class="p">(</span><span class="n">ins</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="origin2sachdr"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.origin2sachdr">[docs]</a><span class="k">def</span> <span class="nf">origin2sachdr</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accepts a fielded origin table record and produces a dictionary of</span>
<span class="sd">    corresponding sac header field/value pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keymap</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;evdp&#39;</span><span class="p">:</span> <span class="s">&#39;depth&#39;</span><span class="p">,</span> <span class="s">&#39;evla&#39;</span><span class="p">:</span> <span class="s">&#39;lat&#39;</span><span class="p">,</span> <span class="s">&#39;evlo&#39;</span><span class="p">:</span> <span class="s">&#39;lon&#39;</span><span class="p">,</span> <span class="s">&#39;kuser1&#39;</span><span class="p">:</span> <span class="s">&#39;auth&#39;</span><span class="p">,</span>
        <span class="s">&#39;nevid&#39;</span><span class="p">:</span> <span class="s">&#39;evid&#39;</span><span class="p">,</span> <span class="s">&#39;norid&#39;</span><span class="p">:</span> <span class="s">&#39;orid&#39;</span><span class="p">,</span> <span class="s">&#39;user0&#39;</span><span class="p">:</span> <span class="s">&#39;mb&#39;</span><span class="p">}</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">_buildhdr</span><span class="p">(</span><span class="n">keymap</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hdr</span>
 </div>
<div class="viewcode-block" id="event2sachdr"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.event2sachdr">[docs]</a><span class="k">def</span> <span class="nf">event2sachdr</span><span class="p">(</span><span class="n">evt</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="assoc2sachdr"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.assoc2sachdr">[docs]</a><span class="k">def</span> <span class="nf">assoc2sachdr</span><span class="p">(</span><span class="n">asc</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="arrival2sachdr"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.arrival2sachdr">[docs]</a><span class="k">def</span> <span class="nf">arrival2sachdr</span><span class="p">(</span><span class="n">ar</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{}</span>

</div>
<div class="viewcode-block" id="wfdisc2sachdr"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.wfdisc2sachdr">[docs]</a><span class="k">def</span> <span class="nf">wfdisc2sachdr</span><span class="p">(</span><span class="n">wf</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c">#functions that accept a table, return a dictionary of sac header values</span>
<span class="c">#the order of this dictionary matters</span></div>
<span class="n">KB2SAC</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="s">&#39;site&#39;</span><span class="p">:</span> <span class="n">site2sachdr</span><span class="p">,</span>
          <span class="s">&#39;sitechan&#39;</span><span class="p">:</span> <span class="n">sitechan2sachdr</span><span class="p">,</span>
          <span class="s">&#39;wfdisc&#39;</span><span class="p">:</span> <span class="n">wfdisc2sachdr</span><span class="p">,</span>
          <span class="s">&#39;affiliation&#39;</span><span class="p">:</span> <span class="n">affiliation2sachdr</span><span class="p">,</span>
          <span class="s">&#39;instrument&#39;</span><span class="p">:</span> <span class="n">instrument2sachdr</span><span class="p">,</span>
          <span class="s">&#39;origin&#39;</span><span class="p">:</span> <span class="n">origin2sachdr</span><span class="p">,</span>
          <span class="s">&#39;event&#39;</span><span class="p">:</span> <span class="n">event2sachdr</span><span class="p">,</span>
          <span class="s">&#39;assoc&#39;</span><span class="p">:</span> <span class="n">assoc2sachdr</span><span class="p">,</span>
          <span class="s">&#39;arrival&#39;</span><span class="p">:</span> <span class="n">arrival2sachdr</span><span class="p">})</span>

<div class="viewcode-block" id="tables2sachdr"><a class="viewcode-back" href="../../../pisces.io.sac.html#pisces.io.sac.tables2sachdr">[docs]</a><span class="k">def</span> <span class="nf">tables2sachdr</span><span class="p">(</span><span class="n">tables</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a sac header dictionary, including default values, from</span>
<span class="sd">    current table instances.  SAC reference time is, in order of availability,</span>
<span class="sd">    origin time (origin.time), first sample time (wfdisc.time). </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>              

    <span class="n">hdr</span> <span class="o">=</span> <span class="n">SACDEFAULT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">tabfun</span> <span class="ow">in</span> <span class="n">KB2SAC</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tabfun</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="bp">None</span><span class="p">)))</span>
        
    <span class="k">return</span> <span class="n">hdr</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Table Of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pisces.html">pisces package</a></li>
</ul>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pisces 0.2.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Jonathan MacCarthy.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>